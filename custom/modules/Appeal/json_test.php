<?php
//$filename = '_z33DijKNGE.jpg';
//$file_folder = '2088497717c24b01a5f7d916bd2d2728';
//$url = 'https://suitecrmdemosugareru.webim.ru/l/o/download/'.$file_folder.'/'.$filename;
////$res = file_put_contents('upload/'.$file_folder.'/'.$filename , fopen($url, 'r'));
//echo $url.'<br>';
////downloadUrlToFile($url,'upload/'.$file_folder.'/'.$filename);
//
//
//set_time_limit(0);
//$file = file_get_contents($url);
//print_r(file_put_contents('upload/'.$file_folder.'/'.$filename, $file));
//
//
//
//function downloadUrlToFile($url, $outFileName)
//{
//    if(is_file($url)) {
//        copy($url, $outFileName);
//    } else {
//        $options = array(
//            CURLOPT_FILE    => fopen($outFileName, 'w'),
//            CURLOPT_TIMEOUT =>  28800, // set this to 8 hours so we dont timeout on big files
//            CURLOPT_URL     => $url
//        );
//
//        $ch = curl_init();
//        curl_setopt_array($ch, $options);
//        curl_exec($ch);
//        curl_close($ch);
//    }
//}

$str = '{&quot;category&quot;: null, &quot;start_page&quot;: {&quot;url&quot;: &quot;https://telegram.org/&quot;}, &quot;subcategory&quot;: null, &quot;locale&quot;: &quot;ru&quot;, &quot;visitor&quot;: {&quot;fields&quot;: {&quot;name&quot;: &quot;Sergey D&quot;}, &quot;id&quot;: &quot;182f9a7bfdf6d05214085914f24df206&quot;, &quot;channel&quot;: {&quot;user_id&quot;: 434566562, &quot;type&quot;: &quot;telegram&quot;, &quot;id&quot;: &quot;42c21650b86a4f2b918994374f9ac349&quot;}}, &quot;created_at&quot;: &quot;2018-11-11T22:06:01Z&quot;, &quot;messages&quot;: [{&quot;created_at&quot;: &quot;2018-11-11T22:06:01Z&quot;, &quot;message&quot;: &quot;\u041f\u043e\u0441\u0435\u0442\u0438\u0442\u0435\u043b\u044c \u043e\u0442\u043a\u0440\u044b\u043b \u043e\u043a\u043d\u043e \u0434\u0438\u0430\u043b\u043e\u0433\u0430 \u0441\u043e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b Telegram: https://telegram.org/\n\u0411\u0440\u0430\u0443\u0437\u0435\u0440: Other\n\u0418\u043c\u044f: Sergey D&quot;, &quot;kind&quot;: &quot;for_operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:06:01Z&quot;, &quot;message&quot;: &quot;\u041f\u043e\u0436\u0430\u043b\u0443\u0439\u0441\u0442\u0430, \u043f\u043e\u0434\u043e\u0436\u0434\u0438\u0442\u0435 \u043d\u0435\u043c\u043d\u043e\u0433\u043e, \u043a \u0412\u0430\u043c \u043f\u0440\u0438\u0441\u043e\u0435\u0434\u0438\u043d\u0438\u0442\u0441\u044f \u043e\u043f\u0435\u0440\u0430\u0442\u043e\u0440...&quot;, &quot;kind&quot;: &quot;info&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:06:01Z&quot;, &quot;message&quot;: &quot;Q&quot;, &quot;kind&quot;: &quot;visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:06:01Z&quot;, &quot;message&quot;: &quot;Qq&quot;, &quot;kind&quot;: &quot;visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:06:01Z&quot;, &quot;message&quot;: &quot;H&quot;, &quot;kind&quot;: &quot;visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:06:09Z&quot;, &quot;message&quot;: &quot;Gg&quot;, &quot;kind&quot;: &quot;visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:06:19Z&quot;, &quot;message&quot;: &quot;\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 \u0421\u0435\u0440\u0433\u0435\u0439 \u0432\u043a\u043b\u044e\u0447\u0438\u043b\u0441\u044f \u0432 \u0440\u0430\u0437\u0433\u043e\u0432\u043e\u0440&quot;, &quot;kind&quot;: &quot;info&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:06:19Z&quot;, &quot;operator_id&quot;: 185011, &quot;message&quot;: &quot;qq&quot;, &quot;kind&quot;: &quot;operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:06:22Z&quot;, &quot;operator_id&quot;: 185011, &quot;message&quot;: &quot;\u0447\u0435 \u043d\u0430\u0434\u043e&quot;, &quot;kind&quot;: &quot;operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:06:26Z&quot;, &quot;message&quot;: &quot;\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 \u0437\u0430\u043a\u0440\u044b\u043b \u0434\u0438\u0430\u043b\u043e\u0433&quot;, &quot;kind&quot;: &quot;info&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:06:43Z&quot;, &quot;message&quot;: &quot;/quit&quot;, &quot;kind&quot;: &quot;visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:06:47Z&quot;, &quot;message&quot;: &quot;/quit&quot;, &quot;kind&quot;: &quot;visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:06:54Z&quot;, &quot;message&quot;: &quot;/exit&quot;, &quot;kind&quot;: &quot;visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:07:05Z&quot;, &quot;message&quot;: &quot;/help&quot;, &quot;kind&quot;: &quot;visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-11T22:07:10Z&quot;, &quot;message&quot;: &quot;\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 \u0437\u0430\u043a\u0440\u044b\u043b \u0434\u0438\u0430\u043b\u043e\u0433&quot;, &quot;kind&quot;: &quot;info&quot;}], &quot;department_key&quot;: &quot;&quot;, &quot;operator&quot;: {&quot;id&quot;: 185011, &quot;email&quot;: &quot;qpopuk@yandex.ru&quot;, &quot;name&quot;: &quot;\u0421\u0435\u0440\u0433\u0435\u0439&quot;}, &quot;id&quot;: 5, &quot;visit_session&quot;: {&quot;ip&quot;: &quot;&quot;, &quot;landing_page&quot;: {&quot;url&quot;: &quot;https://telegram.org/&quot;}}}';
//$str = '{&quot;category&quot;: null, &quot;start_page&quot;: {&quot;url&quot;: &quot;http://suitecrm-demo.sugare.ru/index.php?module=Calls&action=chat&quot;}, &quot;subcategory&quot;: null, &quot;locale&quot;: &quot;ru&quot;, &quot;visitor&quot;: {&quot;fields&quot;: {&quot;phone&quot;: &quot;+7 (978) 827-49-03&quot;, &quot;name&quot;: &quot;\u0421\u0435\u0440\u0433\u0435\u0439&quot;, &quot;email&quot;: &quot;qpopuk@yandex.ru&quot;}, &quot;id&quot;: &quot;411db6ffee0e4e8f8486813748f8c5d7&quot;}, &quot;created_at&quot;: &quot;2018-11-08T07:39:52Z&quot;, &quot;messages&quot;: [{&quot;created_at&quot;: &quot;2018-11-08T07:39:52Z&quot;, &quot;message&quot;: &quot;\u041f\u043e\u0441\u0435\u0442\u0438\u0442\u0435\u043b\u044c \u043e\u0442\u043a\u0440\u044b\u043b \u043e\u043a\u043d\u043e \u0434\u0438\u0430\u043b\u043e\u0433\u0430 \u0441\u043e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b SuiteCRM: http://suitecrm-demo.sugare.ru/index.php?module=Calls&action=chat\n\u041c\u0435\u0441\u0442\u043e\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u0435: \u0420\u043e\u0441\u0441\u0438\u044f, \u0421\u0435\u0432\u0430\u0441\u0442\u043e\u043f\u043e\u043b\u044c  http://maps.google.com/maps?q=44.508850,33.600510\n\u0411\u0440\u0430\u0443\u0437\u0435\u0440: Firefox 63\nIP: https://www.nic.ru/whois/?query=109.110.84.100\n\u0422\u0435\u043b\u0435\u0444\u043e\u043d: +7 (978) 827-49-03\n\u0418\u043c\u044f: \u0421\u0435\u0440\u0433\u0435\u0439\nE-mail: qpopuk@yandex.ru\n\u041f\u0440\u0438\u0448\u0435\u043b \u0441 http://suitecrm-demo.sugare.ru/index.php?action=Login&module=Users&login_module=Calls&login_action=chat&quot;, &quot;kind&quot;: &quot;for_operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T07:39:52Z&quot;, &quot;message&quot;: &quot;\u041f\u043e\u0436\u0430\u043b\u0443\u0439\u0441\u0442\u0430, \u043f\u043e\u0434\u043e\u0436\u0434\u0438\u0442\u0435 \u043d\u0435\u043c\u043d\u043e\u0433\u043e, \u043a \u0412\u0430\u043c \u043f\u0440\u0438\u0441\u043e\u0435\u0434\u0438\u043d\u0438\u0442\u0441\u044f \u043e\u043f\u0435\u0440\u0430\u0442\u043e\u0440...&quot;, &quot;kind&quot;: &quot;info&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T07:39:58Z&quot;, &quot;message&quot;: &quot;\u041f\u043e\u0441\u0435\u0442\u0438\u0442\u0435\u043b\u044c \u043f\u0435\u0440\u0435\u0448\u0435\u043b \u043d\u0430 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443 \&quot;SuiteCRM\&quot; (http://suitecrm-demo.sugare.ru/index.php?module=Calls&action=chat ).&quot;, &quot;kind&quot;: &quot;for_operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T07:40:03Z&quot;, &quot;message&quot;: &quot;\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 \u0437\u0430\u043a\u0440\u044b\u043b \u0434\u0438\u0430\u043b\u043e\u0433&quot;, &quot;kind&quot;: &quot;info&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T07:40:05Z&quot;, &quot;message&quot;: &quot;\u041f\u043e\u0441\u0435\u0442\u0438\u0442\u0435\u043b\u044c \u043f\u0435\u0440\u0435\u0448\u0435\u043b \u043d\u0430 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443 \&quot;SuiteCRM\&quot; (http://suitecrm-demo.sugare.ru/index.php?module=Calls&action=chat ).&quot;, &quot;kind&quot;: &quot;for_operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T07:40:11Z&quot;, &quot;message&quot;: &quot;\u043a\u0443&quot;, &quot;kind&quot;: &quot;visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T07:40:15Z&quot;, &quot;message&quot;: &quot;\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 \u0421\u0435\u0440\u0433\u0435\u0439 \u0432\u043a\u043b\u044e\u0447\u0438\u043b\u0441\u044f \u0432 \u0440\u0430\u0437\u0433\u043e\u0432\u043e\u0440&quot;, &quot;kind&quot;: &quot;info&quot;}], &quot;department_key&quot;: &quot;&quot;, &quot;operator&quot;: {&quot;id&quot;: 184872, &quot;email&quot;: &quot;dzyba@sugare.ru&quot;, &quot;name&quot;: &quot;\u0421\u0435\u0440\u0433\u0435\u0439&quot;}, &quot;id&quot;: 29, &quot;visit_session&quot;: {&quot;ip&quot;: &quot;109.110.84.100&quot;, &quot;landing_page&quot;: {&quot;url&quot;: &quot;http://suitecrm-demo.sugare.ru/index.php?module=Calls&action=chat&quot;}}}';
//$str = '{&quot;category&quot;: null, &quot;start_page&quot;: {&quot;url&quot;: &quot;http://suitecrm-demo.sugare.ru/index.php?module=Calls&action=chat&quot;}, &quot;subcategory&quot;: null, &quot;locale&quot;: &quot;ru&quot;, &quot;visitor&quot;: {&quot;fields&quot;: {&quot;phone&quot;: &quot;+7 (978) 827-49-03&quot;, &quot;name&quot;: &quot;\u0421\u0435\u0440\u0433\u0435\u0439&quot;, &quot;email&quot;: &quot;qpopuk@yandex.ru&quot;}, &quot;id&quot;: &quot;411db6ffee0e4e8f8486813748f8c5d7&quot;}, &quot;created_at&quot;: &quot;2018-11-08T12:16:09Z&quot;, &quot;messages&quot;: [{&quot;created_at&quot;: &quot;2018-11-08T12:16:09Z&quot;, &quot;message&quot;: &quot;\u041f\u043e\u0441\u0435\u0442\u0438\u0442\u0435\u043b\u044c \u043e\u0442\u043a\u0440\u044b\u043b \u043e\u043a\u043d\u043e \u0434\u0438\u0430\u043b\u043e\u0433\u0430 \u0441\u043e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b SuiteCRM: http://suitecrm-demo.sugare.ru/index.php?module=Calls&action=chat\n\u041c\u0435\u0441\u0442\u043e\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u0435: \u0420\u043e\u0441\u0441\u0438\u044f, \u0421\u0435\u0432\u0430\u0441\u0442\u043e\u043f\u043e\u043b\u044c  http://maps.google.com/maps?q=44.508850,33.600510\n\u0411\u0440\u0430\u0443\u0437\u0435\u0440: Firefox 63\nIP: https://www.nic.ru/whois/?query=109.110.84.100\n\u0422\u0435\u043b\u0435\u0444\u043e\u043d: +7 (978) 827-49-03\n\u0418\u043c\u044f: \u0421\u0435\u0440\u0433\u0435\u0439\nE-mail: qpopuk@yandex.ru\n\u041f\u0440\u0438\u0448\u0435\u043b \u0441 http://suitecrm-demo.sugare.ru/index.php?action=Login&module=Users&login_module=Calls&login_action=chat&quot;, &quot;kind&quot;: &quot;for_operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T12:16:09Z&quot;, &quot;message&quot;: &quot;\u041f\u043e\u0436\u0430\u043b\u0443\u0439\u0441\u0442\u0430, \u043f\u043e\u0434\u043e\u0436\u0434\u0438\u0442\u0435 \u043d\u0435\u043c\u043d\u043e\u0433\u043e, \u043a \u0412\u0430\u043c \u043f\u0440\u0438\u0441\u043e\u0435\u0434\u0438\u043d\u0438\u0442\u0441\u044f \u043e\u043f\u0435\u0440\u0430\u0442\u043e\u0440...&quot;, &quot;kind&quot;: &quot;info&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T12:16:15Z&quot;, &quot;message&quot;: &quot;\u043f\u0435\u0440\u0432\u043e\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435&quot;, &quot;kind&quot;: &quot;visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T12:16:17Z&quot;, &quot;message&quot;: &quot;\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 \u0421\u0435\u0440\u0433\u0435\u0439 \u0432\u043a\u043b\u044e\u0447\u0438\u043b\u0441\u044f \u0432 \u0440\u0430\u0437\u0433\u043e\u0432\u043e\u0440&quot;, &quot;kind&quot;: &quot;info&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T12:16:20Z&quot;, &quot;operator_id&quot;: 184872, &quot;message&quot;: &quot;\u0432\u0442\u043e\u0440\u043e\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435&quot;, &quot;kind&quot;: &quot;operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T12:16:28Z&quot;, &quot;message&quot;: &quot;3 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435&quot;, &quot;kind&quot;: &quot;visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T12:16:32Z&quot;, &quot;operator_id&quot;: 184872, &quot;message&quot;: &quot;4 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435&quot;, &quot;kind&quot;: &quot;operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T12:17:09Z&quot;, &quot;message&quot;: &quot;\u043a\u043e\u043d\u0435\u0446&quot;, &quot;kind&quot;: &quot;visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T12:17:14Z&quot;, &quot;operator_id&quot;: 184872, &quot;message&quot;: &quot;\u043f\u043e\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0430\u044e&quot;, &quot;kind&quot;: &quot;operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T12:17:15Z&quot;, &quot;message&quot;: &quot;\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 \u0437\u0430\u043a\u0440\u044b\u043b \u0434\u0438\u0430\u043b\u043e\u0433&quot;, &quot;kind&quot;: &quot;info&quot;}], &quot;department_key&quot;: &quot;&quot;, &quot;operator&quot;: {&quot;id&quot;: 184872, &quot;email&quot;: &quot;dzyba@sugare.ru&quot;, &quot;name&quot;: &quot;\u0421\u0435\u0440\u0433\u0435\u0439&quot;}, &quot;id&quot;: 30, &quot;visit_session&quot;: {&quot;ip&quot;: &quot;109.110.84.100&quot;, &quot;landing_page&quot;: {&quot;url&quot;: &quot;http://suitecrm-demo.sugare.ru/index.php?module=Calls&action=chat&quot;}}}';
//$str = '{&quot;category&quot;: null, &quot;start_page&quot;: {&quot;url&quot;: &quot;http://suitecrm-demo.sugare.ru/index.php?module=Calls&action=chat&quot;}, &quot;subcategory&quot;: null, &quot;locale&quot;: &quot;ru&quot;, &quot;visitor&quot;: {&quot;fields&quot;: {&quot;phone&quot;: &quot;+7 (978) 827-49-03&quot;, &quot;name&quot;: &quot;\u0421\u0435\u0440\u0433\u0435\u0439&quot;, &quot;email&quot;: &quot;qpopuk@yandex.ru&quot;}, &quot;id&quot;: &quot;411db6ffee0e4e8f8486813748f8c5d7&quot;}, &quot;created_at&quot;: &quot;2018-11-08T13:31:37Z&quot;, &quot;messages&quot;: [{&quot;created_at&quot;: &quot;2018-11-08T13:31:37Z&quot;, &quot;message&quot;: &quot;\u041f\u043e\u0441\u0435\u0442\u0438\u0442\u0435\u043b\u044c \u043e\u0442\u043a\u0440\u044b\u043b \u043e\u043a\u043d\u043e \u0434\u0438\u0430\u043b\u043e\u0433\u0430 \u0441\u043e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b SuiteCRM: http://suitecrm-demo.sugare.ru/index.php?module=Calls&action=chat\n\u041c\u0435\u0441\u0442\u043e\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u0435: \u0420\u043e\u0441\u0441\u0438\u044f, \u0421\u0435\u0432\u0430\u0441\u0442\u043e\u043f\u043e\u043b\u044c  http://maps.google.com/maps?q=44.508850,33.600510\n\u0411\u0440\u0430\u0443\u0437\u0435\u0440: Firefox 63\nIP: https://www.nic.ru/whois/?query=109.110.84.100\n\u0422\u0435\u043b\u0435\u0444\u043e\u043d: +7 (978) 827-49-03\n\u0418\u043c\u044f: \u0421\u0435\u0440\u0433\u0435\u0439\nE-mail: qpopuk@yandex.ru\n\u041f\u0440\u0438\u0448\u0435\u043b \u0441 http://suitecrm-demo.sugare.ru/index.php?action=Login&module=Users&login_module=Calls&login_action=chat&quot;, &quot;kind&quot;: &quot;for_operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T13:31:37Z&quot;, &quot;message&quot;: &quot;\u041f\u043e\u0436\u0430\u043b\u0443\u0439\u0441\u0442\u0430, \u043f\u043e\u0434\u043e\u0436\u0434\u0438\u0442\u0435 \u043d\u0435\u043c\u043d\u043e\u0433\u043e, \u043a \u0412\u0430\u043c \u043f\u0440\u0438\u0441\u043e\u0435\u0434\u0438\u043d\u0438\u0442\u0441\u044f \u043e\u043f\u0435\u0440\u0430\u0442\u043e\u0440...&quot;, &quot;kind&quot;: &quot;info&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T13:31:39Z&quot;, &quot;message&quot;: &quot;q&quot;, &quot;kind&quot;: &quot;visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T13:31:42Z&quot;, &quot;message&quot;: &quot;\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 \u0421\u0435\u0440\u0433\u0435\u0439 \u0432\u043a\u043b\u044e\u0447\u0438\u043b\u0441\u044f \u0432 \u0440\u0430\u0437\u0433\u043e\u0432\u043e\u0440&quot;, &quot;kind&quot;: &quot;info&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T13:31:43Z&quot;, &quot;operator_id&quot;: 184872, &quot;message&quot;: &quot;q&quot;, &quot;kind&quot;: &quot;operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T13:31:49Z&quot;, &quot;message&quot;: &quot;{\&quot;client_content_type\&quot;: \&quot;application/pdf\&quot;, \&quot;visitor_id\&quot;: \&quot;411db6ffee0e4e8f8486813748f8c5d7\&quot;, \&quot;filename\&quot;: \&quot;Document.pdf\&quot;, \&quot;content_type\&quot;: \&quot;application/pdf\&quot;, \&quot;guid\&quot;: \&quot;babc818d633544639ed6e484b3e6a21f\&quot;, \&quot;size\&quot;: 247984}&quot;, &quot;kind&quot;: &quot;file_visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T13:31:59Z&quot;, &quot;operator_id&quot;: 184872, &quot;message&quot;: &quot;\u041d\u0430\u0447\u0430\u0442\u0430 \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0430 \u0444\u0430\u0439\u043b\u0430: _z33DijKNGE.jpg&quot;, &quot;kind&quot;: &quot;for_operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T13:32:00Z&quot;, &quot;operator_id&quot;: 184872, &quot;message&quot;: &quot;{\&quot;client_content_type\&quot;: \&quot;image/jpeg\&quot;, \&quot;image\&quot;: {\&quot;size\&quot;: {\&quot;width\&quot;: 1280, \&quot;height\&quot;: 800}}, \&quot;visitor_id\&quot;: \&quot;411db6ffee0e4e8f8486813748f8c5d7\&quot;, \&quot;filename\&quot;: \&quot;_z33DijKNGE.jpg\&quot;, \&quot;content_type\&quot;: \&quot;image/jpeg\&quot;, \&quot;guid\&quot;: \&quot;2088497717c24b01a5f7d916bd2d2728\&quot;, \&quot;size\&quot;: 91427}&quot;, &quot;kind&quot;: &quot;file_operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T13:32:11Z&quot;, &quot;message&quot;: &quot;{\&quot;client_content_type\&quot;: \&quot;image/jpeg\&quot;, \&quot;image\&quot;: {\&quot;size\&quot;: {\&quot;width\&quot;: 1280, \&quot;height\&quot;: 711}}, \&quot;visitor_id\&quot;: \&quot;411db6ffee0e4e8f8486813748f8c5d7\&quot;, \&quot;filename\&quot;: \&quot;GCv0Ynvg1pA.jpg\&quot;, \&quot;content_type\&quot;: \&quot;image/jpeg\&quot;, \&quot;guid\&quot;: \&quot;515acd2a7e204a24982a6d74c6a41d3c\&quot;, \&quot;size\&quot;: 71795}&quot;, &quot;kind&quot;: &quot;file_visitor&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T13:32:17Z&quot;, &quot;operator_id&quot;: 184872, &quot;message&quot;: &quot;ok, bye&quot;, &quot;kind&quot;: &quot;operator&quot;}, {&quot;created_at&quot;: &quot;2018-11-08T13:32:19Z&quot;, &quot;message&quot;: &quot;\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 \u0437\u0430\u043a\u0440\u044b\u043b \u0434\u0438\u0430\u043b\u043e\u0433&quot;, &quot;kind&quot;: &quot;info&quot;}], &quot;department_key&quot;: &quot;&quot;, &quot;operator&quot;: {&quot;id&quot;: 184872, &quot;email&quot;: &quot;dzyba@sugare.ru&quot;, &quot;name&quot;: &quot;\u0421\u0435\u0440\u0433\u0435\u0439&quot;}, &quot;id&quot;: 33, &quot;visit_session&quot;: {&quot;ip&quot;: &quot;109.110.84.100&quot;, &quot;landing_page&quot;: {&quot;url&quot;: &quot;http://suitecrm-demo.sugare.ru/index.php?module=Calls&action=chat&quot;}}}';
$str = html_entity_decode($str);
$str = preg_replace_callback('/\\\\u([0-9a-fA-F]{4})/', function ($match) {
    return mb_convert_encoding(pack('H*', $match[1]), 'UTF-8', 'UCS-2BE');
}, $str);
//print_r($str);
//$json = $str;
header('Content-Type: application/json');
echo $str;
//$resp = json_decode($json, true);
//print_r($resp['id']);
//echo $json;
//var_dump(in_array('file_visitor',$resp['messages']['2']));
//$a = getChatHistoryy($json);
//print_r($a);
//echo $json;
//
//function getChatHistory($chat_json, $first_client_message = false)
//{
//    $params = str_replace('&quot;', '"', $chat_json);
//    $buffer = json_decode($params, true);
//    $history = '';
//    foreach ($buffer['messages'] as $key => $val) {
//        $time_from_response = str_replace(array('T', 'Z'), ' ', $val['created_at']);
//        $date = new DateTime($time_from_response);
//        $date->add(new DateInterval('PT3H'));
//        $timestamp = $date->format('Y-m-d H:i:s');
//        $message_text = $val['message'];
//        switch ($val['kind']) {
//            case 'visitor':
//                $kind = 'Клиент';
//                break;
//            case 'for_operator':
//                $kind = 'Инфо для оператора';
//                break;
//            case 'info':
//                $kind = 'Инфо для клиента';
//                break;
//            case 'operator':
//                $kind = 'Оператор';
//                break;
//            case 'file_operator':
//                $kind = 'Оператор отправил файл';
//                break;
//            case 'file_visitor':
//                $kind = 'Оператор отправил файл';
//                break;
//            default:
//                $kind = 'Сообщение';
//                break;
//        };
//        $history .= $timestamp . '>' . $kind . '>>>' . $message_text . '\n';
//        if ($first_client_message && $val['kind'] === 'visitor')
//            break;
//    }
//    return $history;
//}
//global $timedate, $current_user;
//$file_params = json_decode($item['message'],true);
////filename, content_type, guid
//$docs[0]['filename'] = 'GCv0Ynvg1pA.jpg';
//$docs[0]['file_guid'] = '23609f6aea4948d6b54af930f6bc7a2a';
//$docs[0]['file_content_type'] = 'image';
//$docs[0]['file_source'] = 'file_visitor';//file_visitor OR file_operator
//$docs[0]['file_timestamp'] = '2018-11-11 16:05:05';
//$account_name = 'suitecrmdemosugarerui';
//$docs[0]['file_url'] = 'https://'.$account_name.'.webim.ru/l/o/download/'.$docs[0]['file_guid'].'/'.$docs[0]['filename'];//исправить на что-то универсальное
//
//$doc_ids = array();
//foreach ($docs as $item) {
//    $doc = new Document();
//    $docRev = new DocumentRevision();
//    $doc->date_entered = $timedate->nowDb();
//    $doc->date_modified = $timedate->nowDb();
//    $doc->assigned_user_id = $current_user->id;
//    $doc->modified_user_id = $current_user->id;
//    $doc->created_by = $current_user->id;
//    $doc->description = '';
//    $doc->document_name = $item['filename'];
//    $doc->doc_id = $item['file_guid'];
//    $doc->doc_type = 'Webim_doc';
//    $doc->doc_url = $item['file_url'];
//    $doc->active_date = date("Y-m-d");;
//    $doc->status_id = 'Active';
//    $doc->description = ($item['file_source'] === 'file_visitor')?'Файл передан клиентом':'Файл передан оператором';
//    $doc_id = $doc->save();
//    $doc_ids[]=$doc_id;
//
//    $docRev->retrieve_by_string_fields(array('document_id'=>$doc_id,'change_log'=>'Документ создан'));
//    $docRev->change_log = 'Документ прикреплен';
//    $docRev->document_id = $doc_id;
//    $docRev->doc_id = $item['file_guid'];
//    $docRev->doc_type = 'Webim_doc';
//    $docRev->doc_url = $item['file_url'];
//    $docRev->date_entered = $timedate->nowDb();
//    $docRev->date_modified = $timedate->nowDb();
//    $docRev->created_by = $current_user->id;
//    $buf = explode('.',$item['filename']);
//    $docRev->filename = $item['filename'];
//    $docRev->file_ext = $buf[count($buf)-1];
//    $docRev->file_mime = $item['file_content_type'];
//    $docRev->revision = 1;
//    $docRev_id = $docRev->save();
//    $doc->retrieve($doc_id);
//    $doc->document_revision_id = $docRev_id;
//    $doc->save();
//}
//print_r($doc_ids);

